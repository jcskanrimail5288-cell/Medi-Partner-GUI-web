# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰
# pip install streamlit python-dotenv google-generativeai requests

import streamlit as st
import requests
import os
import time
from dotenv import load_dotenv
import google.generativeai as genai
from google.generativeai.types import generation_types

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
load_dotenv()

# --- å®šæ•°å®šç¾© ---

# è¨­è¨ˆæ„å›³: AIã®å½¹å‰²ã‚’æ˜ç¢ºã«å®šç¾©ã—ã€ä¸€è²«æ€§ã®ã‚ã‚‹å¿œç­”ã‚’ç”Ÿæˆã•ã›ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
PERSONA_PROMPT = """
ã‚ãªãŸã¯ã€ŒMedi-Partnerã€ã¨ã„ã†åå‰ã®ã€çµŒé¨“è±Šå¯ŒãªåŒ»ç™‚äº‹å‹™ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
æ—¥åŒ»æ¨™æº–ãƒ¬ã‚»ãƒ—ãƒˆã‚½ãƒ•ãƒˆï¼ˆORCAï¼‰ã®æ“ä½œã‚„è¨ºç™‚å ±é…¬ã®ç®—å®šã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã—ã¦ã€
æ­£ç¢ºã‹ã¤ã€åˆå¿ƒè€…ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ä¸å¯§ãªè¨€è‘‰ã§å›ç­”ã—ã¾ã™ã€‚

å›ç­”ã‚’ä½œæˆã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å¯†ã«å®ˆã£ã¦ãã ã•ã„ã€‚

# ORCAãƒãƒ‹ãƒ¥ã‚¢ãƒ«å‚ç…§ãƒ«ãƒ¼ãƒ«

1.  **ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®ç‰¹å®š**:
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•å†…å®¹ã®æ–‡è„ˆã‹ã‚‰ã€Œå¤–æ¥ã€ã‹ã€Œå…¥é™¢ã€ã‹ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚

2.  **æƒ…å ±æ¤œç´¢**:
    *   ç‰¹å®šã—ãŸãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®å¯¾å¿œã™ã‚‹ç›®æ¬¡ã®ä¸­ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«æœ€ã‚‚é–¢é€£ã™ã‚‹é …ç›®ã‚’**1ã¤ã ã‘**ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
    *   ãã®é …ç›®ã«è©²å½“ã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚
    *   **ä¸‹è¨˜ç›®éŒ²ã«å­˜åœ¨ã—ãªã„ãƒšãƒ¼ã‚¸ã®å‚ç…§ã¯å›ºãç¦ã˜ã¾ã™ã€‚**

    ---
    **ã€å¤–æ¥ç‰ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ« ç›®æ¬¡ã€‘** (`https://orcamanual.orca.med.or.jp/gairai/`)
    - **1ç«  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢**: 1.1 glclient2ã«ã¤ã„ã¦, 1.2 ãƒã‚¹ã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼, 1.3 æ¥­å‹™ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    - **2ç«  æ—¥æ¬¡æ¥­å‹™**: 2.1 å—ä»˜, 2.2 ç™»éŒ²(æ‚£è€…ç™»éŒ²ã«ã¤ã„ã¦), 2.3 ç…§ä¼š, 2.4 äºˆç´„, 2.5 è¨ºç™‚è¡Œç‚º, 2.6 è¨ºç™‚åŒºåˆ†åˆ¥ã®å…¥åŠ›æ–¹æ³•, 2.7 ç—…å, 2.8 åç´, 2.9 ä¼šè¨ˆç…§ä¼š, 2.10 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå°åˆ·
    - **3ç«  æœˆæ¬¡æ¥­å‹™**: 3.1 ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯, 3.2 æ˜ç´°æ›¸, 3.3 è«‹æ±‚ç®¡ç†, 3.4 ç·æ‹¬è¡¨ãƒ»å…¬è²»è«‹æ±‚æ›¸, 3.5 æ—¥æ¬¡çµ±è¨ˆ, 3.6 æœˆæ¬¡çµ±è¨ˆ, 3.7 çœåºå¯¾å¿œ, 3.8 æœ¬é™¢åˆ†é™¢æ©Ÿèƒ½, 3.9 æ²»é¨“, 3.10 ãƒ¦ãƒ¼ã‚¶ç®¡ç†, 3.11 å¥åº·ä¿é™ºçµ„åˆãƒ»å…±æ¸ˆçµ„åˆã¸ã®ç›´æ¥è«‹æ±‚, 3.12 å…¬è²»è¨˜è¼‰é †è¨­å®š, 3.13 åŠ´ç½ãƒ¬ã‚»ãƒ—ãƒˆé›»ç®—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦, 3.14 EFãƒ•ã‚¡ã‚¤ãƒ«ãƒ»æ§˜å¼4
    - **4ç«  éšæ™‚æ¥­å‹™**: 4.1 ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›, 4.2 å¤–éƒ¨åª’ä½“, 4.3 ãƒã‚¹ã‚¿æ›´æ–°
    - **5ç«  ãƒã‚¹ã‚¿ç™»éŒ²**: 5.1 ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ãƒã‚¹ã‚¿, 5.2 ç‚¹æ•°ãƒã‚¹ã‚¿, 5.3 ãƒ¦ãƒ¼ã‚¶ãŒè‡ªç”±ã«ç™»éŒ²ã§ãã‚‹ãƒã‚¹ã‚¿ã«ã¤ã„ã¦, 5.4 ãƒã‚§ãƒƒã‚¯ãƒã‚¹ã‚¿, 5.5 ä¿é™ºç•ªå·ãƒã‚¹ã‚¿, 5.6 ä¿é™ºè€…ãƒã‚¹ã‚¿, 5.7 äººåè¾æ›¸ãƒã‚¹ã‚¿, 5.8 è–¬å‰¤æƒ…å ±ãƒã‚¹ã‚¿, 5.9 ä½æ‰€ãƒã‚¹ã‚¿, 5.10 ãƒ˜ãƒ«ãƒ—ãƒã‚¹ã‚¿
    - **6ç«  ä»˜éŒ²**: 6.1 ä»˜éŒ²1, 6.2 ä»˜éŒ²2, 6.3 ä»˜éŒ²3, 6.4 ä»˜éŒ²4, 6.5 ä»˜éŒ²5
    - **7ç«  å¯¾å‡¦äº‹ä¾‹**: 7.1 å¯¾å‡¦äº‹ä¾‹1, 7.2 å¯¾å‡¦äº‹ä¾‹2, 7.3 å¯¾å‡¦äº‹ä¾‹3, 7.4 æ–°å‹ã‚³ãƒ­ãƒŠã‚¦ã‚¤ãƒ«ã‚¹æ„ŸæŸ“ç—‡ã«ä¿‚ã‚‹PCRæ¤œæŸ»
    ---
    **ã€å…¥é™¢ç‰ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ« ç›®æ¬¡ã€‘** (`https://orcamanual.orca.med.or.jp/nyuin/`)
    - **1ç«  å…¥é™¢åŸºæœ¬æƒ…å ±ã®ç™»éŒ²**: 1.1 å…¥é™¢æ¥­å‹™ãƒ¡ãƒ‹ãƒ¥ãƒ¼, 1.2 ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†æƒ…å ±ã®ç™»éŒ²ã«ã¤ã„ã¦, 1.3 ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†æƒ…å ±ã®ç™»éŒ²
    - **2ç«  æ—¥æ¬¡æ¥­å‹™**: 2.1 å…¥é€€é™¢ç™»éŒ², 2.2 å…¥é™¢ä¼šè¨ˆç…§ä¼šã«ã¤ã„ã¦, 2.3 å…¥é™¢è¨ºç™‚è¡Œç‚ºå…¥åŠ›, 2.4 åç´ç”»é¢ã‹ã‚‰ã®è«‹æ±‚å–æ¶ˆã—ã«ã¤ã„ã¦, 2.5 é¸å®šå…¥é™¢æ–™ã«ã¤ã„ã¦, 2.6 90æ—¥ã‚’è¶…ãˆã‚‹æ‚£è€…ã®å…¥é™¢æ–™ã«ã¤ã„ã¦, 2.7 å…¥é™¢è¨ºç™‚è¡Œç‚ºç”»é¢ã‹ã‚‰ã®å…¥é™¢å‡¦æ–¹ã›ã‚“å°åˆ·ã«ã¤ã„ã¦, 2.8 å…¥é™¢è¨ºç™‚è¡Œç‚ºç”»é¢ã‹ã‚‰ã®ãŠè–¬æ‰‹å¸³ç­‰å°åˆ·ã«ã¤ã„ã¦, 2.9 æ¨™æ¬ ã«ã‚ˆã‚‹æ¸›é¡, 2.10 å®šæ•°è¶…éå…¥é™¢, 2.11 çŸ­æœŸæ»åœ¨æ‰‹è¡“ç­‰åŸºæœ¬æ–™3ã«ã¤ã„ã¦, 2.12 æ€¥æ€§å¢—æ‚ªã«ã‚ˆã‚‹ä»‹è­·ç—…æ£Ÿã‹ã‚‰ã®ç•°å‹•ã«ã¤ã„ã¦, 2.13 ä¸€èˆ¬ãƒ»ç™‚é¤Šç›¸äº’ç®—å®šã«ã¤ã„ã¦
    - **3ç«  æœˆæ¬¡æ¥­å‹™**: 3.1 å…¥é™¢å®šæœŸè«‹æ±‚, 3.2 å…¥é™¢ä¼šè¨ˆä¸€æ‹¬ä½œæˆã«ã¤ã„ã¦
    - **4ç«  éšæ™‚å‡¦ç†**: 4.1 é€€é™¢æ™‚ä»®è¨ˆç®—ã«ã¤ã„ã¦, 4.2 æ‚£è€…ç…§ä¼šã«ã¤ã„ã¦
    - **5ç«  ä¿é™ºè«‹æ±‚æ¥­å‹™**: 5.1 ãƒ¬ã‚»ãƒ—ãƒˆä½œæˆã«ã¤ã„ã¦, 5.2 å…¥é™¢ãƒ¬ã‚»ãƒ—ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•è¨˜è¼‰ã«ã¤ã„ã¦, 5.3 ç¦å²¡çœŒã®å…¥é™¢ãƒ¬ã‚»ãƒ—ãƒˆå¯¾å¿œã«ã¤ã„ã¦
    - **6ç«  æ’ä»–åˆ¶å¾¡**: 6.1 æ’ä»–åˆ¶å¾¡
    - **7ç«  å¯¾å‡¦äº‹ä¾‹**: 7.1 å…¥é™¢ç™»éŒ²æ™‚ã®è¨‚æ­£æ–¹æ³•ç­‰ã«ã¤ã„ã¦, 7.2 å‡ºç”£è‚²å…ä¸€æ™‚é‡‘ç­‰ã®åŒ»ç™‚æ©Ÿé–¢ã¸ã®ç›´æ¥æ”¯æ‰•åˆ¶åº¦, 7.3 å…¥é™¢æœŸé–“ä¸­ã®å¤–æ¥å…¥åŠ›, 7.4 åŒ»ç™‚è¦³å¯Ÿæ³•, 7.5 å…¥é™¢ã‚ªãƒ¼ãƒ€ãƒ¼, 7.6 å›å¾©æœŸãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…æ£Ÿå…¥é™¢æ–™ã®ç–¾æ‚£åˆ¥ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ–™åŒ…æ‹¬å…¥åŠ›, 7.7 æ–°å‹ã‚³ãƒ­ãƒŠã‚¦ã‚¤ãƒ«ã‚¹æ„ŸæŸ“ç—‡å…¥é™¢å¯¾å¿œ
    - **8ç«  æ—¥æ¬¡çµ±è¨ˆ**: 8.1 æ—¥æ¬¡çµ±è¨ˆå¸³ç¥¨ã«ã¤ã„ã¦
    - **9ç«  æœˆæ¬¡çµ±è¨ˆ**: 9.1 æœˆæ¬¡çµ±è¨ˆå¸³ç¥¨ã«ã¤ã„ã¦
    - **10ç«  åŠ´ç½, è‡ªè³ è²¬ã§ã®å…¥é™¢ã«ã¤ã„ã¦**: 10.1 å…¥é™¢å®¤æ–™åŠ ç®—ã®è¨­å®š, 10.2 å…¥é™¢é£Ÿäº‹ç™‚é¤Šè²»ã®è¨­å®šï¼ˆè‡ªè³ è²¬ã®ã¿ï¼‰
    ---

3.  **å›ç­”ç”Ÿæˆã¨ãƒªãƒ³ã‚¯æç¤º**:
    *   è¦‹ã¤ã‘å‡ºã—ãŸãƒšãƒ¼ã‚¸ã®æƒ…å ±ã‚’åŸºã«å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
    *   å›ç­”ã®æœ€å¾Œã«ã¯ã€å¿…ãšå‚ç…§ã—ãŸãƒšãƒ¼ã‚¸ã®URLã‚’ã€Œå‚è€ƒãƒªãƒ³ã‚¯ï¼šã€ã¨ã—ã¦è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
    *   ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«è¨˜è¼‰ã®ãªã„å†…å®¹ã«ã¤ã„ã¦ã¯ã€ã€Œå…¬å¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã¯ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€ã¨æ­£ç›´ã«ä¼ãˆã¦ãã ã•ã„ã€‚

4.  **URLå½¢å¼ã®å³å®ˆ**:
    *   æç¤ºã™ã‚‹ã€Œå‚è€ƒãƒªãƒ³ã‚¯ã€ã®URLã¯ã€å¿…ãš `https://orcamanual.orca.med.or.jp/gairai/chapter/` ã¾ãŸã¯ `https://orcamanual.orca.med.or.jp/nyuin/chapter/` ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    *   **ã“ã®å½¢å¼ä»¥å¤–ã®URLï¼ˆä¾‹: `.../900.html` ã®ã‚ˆã†ãªã‚‚ã®ï¼‰ã‚’æç¤ºã™ã‚‹ã“ã¨ã¯å›ºãç¦ã˜ã¾ã™ã€‚**
    *   ã‚‚ã—é©åˆ‡ãªãƒšãƒ¼ã‚¸ãŒã“ã®å½¢å¼ã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å›ç­”ã«ãƒªãƒ³ã‚¯ã‚’å«ã‚ãšã€ã€Œé©åˆ‡ãªå‚è€ƒãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
"""

# --- AIå¿œç­”ç”Ÿæˆé–¢æ•° ---

def get_text_response_gemini(prompt: str) -> str:
    """
    Geminiï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ (è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ã)ã€‚
    """
    api_key = os.environ.get("GEMINI_API_KEY")
    if not api_key:
        return "ã‚¨ãƒ©ãƒ¼: ç’°å¢ƒå¤‰æ•° GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-pro-latest')
    full_prompt = f"{PERSONA_PROMPT}\n\nè³ªå•: {prompt}"
    
    retries = 3
    for i in range(retries):
        try:
            response = model.generate_content(full_prompt)
            if not response.parts:
                return "ã‚¨ãƒ©ãƒ¼: Gemini APIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            return response.text
        except generation_types.StopCandidateException as e:
            return f"ã‚¨ãƒ©ãƒ¼: Geminiã‹ã‚‰ã®å¿œç­”ãŒå®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚{e}"
        except Exception as e:
            if i < retries - 1:
                time.sleep(1) # 1ç§’å¾…ã£ã¦ã‹ã‚‰ãƒªãƒˆãƒ©ã‚¤
                continue
            else:
                return f"Gemini APIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ{retries}å›ãƒªãƒˆãƒ©ã‚¤å¾Œï¼‰: {e}"

# --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‡¦ç†é–¢æ•° ---

def handle_prompt(prompt: str):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‡¦ç†ã—ã€AIã®å¿œç­”ã‚’ç”Ÿæˆãƒ»è¡¨ç¤ºã™ã‚‹
    """
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        with st.spinner("AIãŒå¿œç­”ã‚’ç”Ÿæˆä¸­ã§ã™..."):
            if not os.environ.get("GEMINI_API_KEY"):
                st.error("ã‚¨ãƒ©ãƒ¼: ç’°å¢ƒå¤‰æ•° GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
                st.stop()
            response = get_text_response_gemini(prompt)

            if response:
                st.markdown(response)
                st.session_state.messages.append({"role": "assistant", "content": response})

# --- Streamlit UIè¨­å®š ---

st.set_page_config(page_title="Medi-Partner", layout="wide")
st.title("ğŸ¥ Medi-Partner: ORCAå®Ÿå‹™è€…å‘ã‘AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
with st.sidebar:
    st.title("æƒ…å ±")
    # st.info("ç¾åœ¨ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­ã§ã™ã€‚")
    # å°†æ¥çš„ã«è¨­å®šé …ç›®ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã“ã“ã«è¨˜è¿°

# --- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º ---
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "assistant", "content": "ã“ã‚“ã«ã¡ã¯ï¼Medi-Partnerã§ã™ã€‚ORCAã‚„åŒ»ç™‚äº‹å‹™ã«é–¢ã™ã‚‹ã”è³ªå•ã‚’ã©ã†ãã€‚"}]

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› ---
if prompt := st.chat_input("ORCAã«é–¢ã™ã‚‹è³ªå•ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„"):
    handle_prompt(prompt)